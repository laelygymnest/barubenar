<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Racepack - TCR</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 20px;
    background: #fff7e6;
    color: #333;
    position: relative;
    min-height: 100vh;
  }
  h1 {
    color: #e85c00;
  }
  .login-container, .content-container {
    max-width: 1100px;
    margin: 0 auto;
  }
  .login-container {
    margin-top: 100px;
    text-align: center;
  }
  input[type="password"], input[type="text"] {
    padding: 10px;
    font-size: 1rem;
    width: 300px;
    border: 2px solid #e85c00;
    border-radius: 6px;
  }
  button {
    background: #e85c00;
    border: none;
    color: white;
    padding: 11px 18px;
    margin-left: 10px;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background: #d14f00;
  }
  .warning {
    background: #fff3e0;
    border-left: 6px solid #e85c00;
    padding: 12px 20px;
    margin-bottom: 15px;
    border-radius: 6px;
    font-weight: 600;
  }
  .search-bar {
    margin: 15px 0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .search-bar input {
    flex: 1;
    max-width: 400px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 40px;
    background: white;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
  }
  th, td {
    border: 1px solid #f1a73b;
    padding: 8px 12px;
    font-size: 14px;
    text-align: center;
  }
  th {
    background: #e85c00;
    color: white;
    user-select: none;
  }
  td input {
    width: 100%;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px 6px;
    font-size: 13px;
    box-sizing: border-box;
  }
  td input:disabled {
    background: #f9f9f9;
    color: #999;
  }
  .btn-save {
    background: #f68b1e;
    border: none;
    color: white;
    padding: 6px 10px;
    font-size: 13px;
    border-radius: 5px;
    cursor: pointer;
  }
  .btn-save:hover {
    background: #d16d00;
  }
  .stok-table {
    max-width: 700px;
    margin-bottom: 60px;
  }
  .stok-table th, .stok-table td {
    font-size: 13px;
  }
  .footer-siluet {
    position: fixed;
    bottom: 0; right: 0;
    opacity: 0.12;
    width: 280px;
    user-select: none;
    pointer-events: none;
    z-index: 0;
  }
  /* Logo TCR top-left */
  .logo-tcr {
    position: fixed;
    top: 20px; left: 20px;
    width: 120px;
    user-select: none;
    pointer-events: none;
    opacity: 0.9;
  }
</style>
</head>
<body>

<img src="https://drive.google.com/file/d/1vUNuSYmg8a6hxRO-TrTQUbcltg7baQKi/view?usp=sharing" alt="Logo TCR" class="logo-tcr">

<div class="login-container" id="loginSection">
  <h1>Admin Racepack TCR - Login</h1>
  <input type="password" id="passwordInput" placeholder="Masukkan password" />
  <button onclick="handleLogin()">Login</button>
</div>

<div class="content-container" id="contentSection" style="display:none;">
  <div class="warning">
    JIKA ADA PESERTA YANG PENGAMBILAN RACEPACKNYA DIWAKILKAN DAN TIDAK MEMBAWA SURAT KUASA, MAKA PESERTA BISA MENGIRIM SOFT FILE SURAT KUASA YANG SUDAH DI ISI DAN DITANDATANGANI BESERTA FOTO KTP DAN DI DM KE IG TEGAL CITY RUN. HAL INI UNTUK MENCEGAH HAL YANG TIDAK DIINGINKAN SEPERTI PENGAMBILAN RACEPACK BERULANG.<br>
    <strong>TUNJUKAN ID CARD & EMAIL VERIFIKASI</strong>
  </div>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Cari No BIB / Nama Peserta / Becode" oninput="renderTable()" />
    <button onclick="loadData()">Reload Data</button>
  </div>

  <table class="stok-table" aria-label="Rincian stok size baju">
    <thead>
      <tr>
        <th>Size</th>
        <th>Total Peserta</th>
        <th>Sudah Diambil</th>
        <th>Belum Diambil</th>
      </tr>
    </thead>
    <tbody id="stokBody"></tbody>
  </table>

  <table id="racepackTable" aria-label="Data Racepack">
    <thead>
      <tr>
        <th>No BIB</th>
        <th>Nama Peserta</th>
        <th>Size Baju</th>
        <th>Becode</th>
        <th>Status</th>
        <th>Nama Staff</th>
        <th>Nama Pengambil</th>
        <th>No Tlp Pengambil</th>
        <th>ID Card Pengambil</th>
        <th>Keterangan</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<img src="https://drive.google.com/file/d/1vUNuSYmg8a6hxRO-TrTQUbcltg7baQKi/view?usp=sharing" alt="Runner Silhouette" class="footer-siluet" />

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxJ5rlrXVY9NxoggS2mWnBpDOmH56l8E3Pg6ZaID_z0ZWhZZujKYj_Djm6AKv6m4TOy/exec"; // Ganti URL Web App-mu
  const PASSWORD = "rahasia123"; // Ganti sesuai Apps Script

  let allData = [];
  let loggedIn = false;

  function handleLogin() {
    const passInput = document.getElementById("passwordInput").value.trim();
    if (passInput === PASSWORD) {
      loggedIn = true;
      sessionStorage.setItem("racepackLoggedIn", "true");
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("contentSection").style.display = "block";
      loadData();
    } else {
      alert("Password salah!");
    }
  }

  function checkLogin() {
    if (sessionStorage.getItem("racepackLoggedIn") === "true") {
      loggedIn = true;
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("contentSection").style.display = "block";
      loadData();
    }
  }

  checkLogin();

  async function loadData() {
    try {
      const response = await fetch(WEB_APP_URL);
      if (!response.ok) throw new Error("Gagal mengambil data");
      allData = await response.json();
      renderStok();
      renderTable();
    } catch (err) {
      alert("Gagal ambil data: " + err.message);
    }
  }

  function renderStok() {
    // Hitung total per size dan status
    const sizes = ["XS","S","M","L","XL","XXL","XXXL"];
    const stok = {};
    sizes.forEach(s => stok[s] = { total: 0, taken: 0 });

    allData.forEach(row => {
      const size = (row.size_baju || "").toUpperCase();
      if (sizes.includes(size)) {
        stok[size].total++;
        if ((row.status || "").toLowerCase() === "sudah diambil") {
          stok[size].taken++;
        }
      }
    });

    const stokBody = document.getElementById("stokBody");
    stokBody.innerHTML = "";

    let totalAll = 0, totalTaken = 0;
    sizes.forEach(size => {
      const taken = stok[size].taken;
      const total = stok[size].total;
      const belum = total - taken;
      totalAll += total;
      totalTaken += taken;

      stokBody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${size}</td>
          <td>${total}</td>
          <td>${taken}</td>
          <td>${belum}</td>
        </tr>
      `);
    });

    // Tambah baris total keseluruhan
    stokBody.insertAdjacentHTML("beforeend", `
      <tr style="font-weight:bold; background:#ffe6cc;">
        <td>Total Keseluruhan</td>
        <td>${totalAll}</td>
        <td>${totalTaken}</td>
        <td>${totalAll - totalTaken}</td>
      </tr>
    `);
  }

  function renderTable() {
    const filter = document.getElementById("searchInput").value.trim().toLowerCase();
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    const filtered = allData.filter(row => {
      return row.no_bib.toString().toLowerCase().includes(filter)
        || (row.nama_peserta || "").toLowerCase().includes(filter)
        || (row.bercode || "").toLowerCase().includes(filter);
    });

    filtered.forEach((row, index) => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${row.no_bib}</td>
          <td>${row.nama_peserta}</td>
          <td>${row.size_baju}</td>
          <td><input type="text" value="${row.bercode || ''}" data-field="bercode" data-index="${index}"></td>
          <td><input type="text" value="${row.status || ''}" data-field="status" data-index="${index}"></td>
          <td><input type="text" value="${row.nama_staff || ''}" data-field="nama_staff" data-index="${index}"></td>
          <td><input type="text" value="${row.nama_pengambil || ''}" data-field="nama_pengambil" data-index="${index}"></td>
          <td><input type="text" value="${row.no_tlp_pengambil || ''}" data-field="no_tlp_pengambil" data-index="${index}"></td>
          <td><input type="text" value="${row.id_card_pengambil || ''}" data-field="id_card_pengambil" data-index="${index}"></td>
          <td><input type="text" value="${row.keterangan || ''}" data-field="keterangan" data-index="${index}"></td>
          <td><button class="btn-save" onclick="saveRow(${index})">Simpan</button></td>
        </tr>
      `);
    });
  }

  async function saveRow(index) {
    if (!loggedIn) {
      alert("Silakan login terlebih dahulu!");
      return;
    }
    const tbody = document.getElementById("tableBody");
    const tr = tbody.children[index];
    if (!tr) return;

    // Ambil semua input di baris ini
    const inputs = tr.querySelectorAll("input");
    const updatedRow = { no_bib: allData[index].no_bib };

    inputs.forEach(input => {
      updatedRow[input.dataset.field] = input.value.trim();
    });
    updatedRow.password = PASSWORD;

    try {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify(updatedRow),
        headers: { "Content-Type": "application/json" }
      });
      const json = await res.json();
      if (json.success) {
        alert("Data berhasil disimpan!");
        loadData();
      } else {
        alert("Gagal simpan data: " + (json.message || "Unknown error"));
      }
    } catch (err) {
      alert("Error saat simpan: " + err.message);
    }
  }
</script>

</body>
</html>
