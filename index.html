<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Racepack ‚Äî Edit & Simpan</title>
<style>
  :root{--accent:#ff7f27;--green:#1b8f3b;--red:#b02a2a}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px;background:#f6f6f6}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  h1{margin:0}
  .warning{background:#fff4e6;border-left:6px solid var(--accent);padding:12px;border-radius:6px;margin-bottom:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  input[type="text"], input[type="password"], select{padding:8px;border:1px solid #ddd;border-radius:6px}
  button{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
  th{background:var(--accent);color:#fff}
  .status-badge{padding:4px 8px;border-radius:999px;color:#fff;font-size:12px}
  .sudah{background:var(--green)} .belum{background:var(--red)}
  .stat-grid{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .stat{background:#fff;padding:10px;border-radius:6px;border:1px solid #eee;min-width:140px;text-align:center}
  .n{font-weight:700;color:var(--accent);font-size:18px}
  .msg{padding:8px;border-radius:6px;margin-bottom:8px}
  .msg.error{background:#ffe6e6;color:#900}
  .msg.ok{background:#e6ffef;color:#0a6}
</style>
</head>
<body>

<header>
  <div style="width:48px;height:48px;border-radius:8px;background:#fff5e6;display:flex;align-items:center;justify-content:center;border:1px solid #ffd1a8">üèÉ‚Äç‚ôÄÔ∏è</div>
  <div>
    <h1>Admin Racepack ‚Äî Edit Pengambilan</h1>
    <div style="color:#666;font-size:13px">Login sekali, lalu simpan baris tanpa memasukkan password lagi (session aktif sampai tab ditutup).</div>
  </div>
</header>

<div class="warning">
  JIKA ADA PESERTA YANG PENGAMBILAN RACEPACKNYA DIWAKILKAN DAN TIDAK MEMBAWA SURAT KUASA, MAKA PESERTA BISA MENGIRIM SOFT FILE SURAT KUASA YANG SUDAH DI ISI DAN DITANDATANGANI BESERTA FOTO KTP DAN DI DM KE IG TEGAL CITY RUN. HAL INI UNTUK MENCEGAH HAL YANG TIDAK DIINGINKAN SEPERTI PENGAMBILAN RACEPACK BERULANG. <strong>TUNJUKAN ID CARD & EMAIL VERIFIKASI</strong>
</div>

<div id="messages"></div>

<div class="controls">
  <input id="pwd" type="password" placeholder="Masukkan password untuk update (disimpan sesion)" />
  <button id="btnLogin">Login</button>
  <input id="q" type="text" placeholder="Cari No BIB / Nama / Barcode..." style="flex:1" />
  <button id="btnReload">Reload</button>
</div>

<div class="stat-grid" id="statGrid"></div>

<table id="tbl">
  <thead>
    <tr>
      <th>No BIB</th><th>Nama Peserta</th><th>Size</th><th>Barcode</th>
      <th>Status</th><th>Nama Staff</th><th>Nama Pengambil</th><th>No. Tlp</th><th>ID Card</th><th>Keterangan</th><th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const WEBAPP = "https://script.google.com/macros/s/AKfycbwju6ztDAnn7Sd9PCwHx1PMTxslFx-8nd_6-TU1qWDAigPL15zdbuqBNF4mQFLcoRNq/exec";
const SKIP = 7;

function showMsg(text, type='error'){ const m=document.getElementById('messages'); m.innerHTML = '<div class=\"msg '+(type==='ok'?'ok':'error')+'\">'+text+'</div>'; setTimeout(()=>{ if(m) m.innerHTML=''; },5000); }
function el(tag, attrs={}, html=''){ const e=document.createElement(tag); for(const k in attrs) e.setAttribute(k, attrs[k]); e.innerHTML = html; return e; }

let DATA = [], FILTERED = [];

// session password storage
if(sessionStorage.getItem('racepack_pwd')){
  document.getElementById('pwd').value = sessionStorage.getItem('racepack_pwd');
}

document.getElementById('btnLogin').addEventListener('click', ()=>{
  const p = document.getElementById('pwd').value.trim();
  if(!p){ showMsg('Password tidak boleh kosong'); return; }
  sessionStorage.setItem('racepack_pwd', p);
  loadData();
});

document.getElementById('btnReload').addEventListener('click', ()=> loadData());
document.getElementById('q').addEventListener('input', ()=> { const v=this.value; filterTable(); });

async function loadData(){
  try{
    const r = await fetch(WEBAPP + '?_=' + Date.now());
    if(!r.ok) throw new Error('HTTP '+r.status);
    const json = await r.json();
    // if API returns object { peserta: [...] } handle that
    let arr = Array.isArray(json) ? json : (json.peserta ? json.peserta : []);
    DATA = arr.slice(SKIP); FILTERED = DATA.slice();
    renderStats();
    renderTable(FILTERED);
    showMsg('Data dimuat', 'ok');
  }catch(err){
    console.error(err);
    showMsg('Gagal ambil data: '+ (err.message || err), 'error');
  }
}

function renderStats(){
  const total = DATA.length;
  const taken = DATA.filter(d => (d.status||'').toLowerCase().includes('sudah')).length;
  const notTaken = total - taken;
  const sizes = ['XS','S','M','L','XL','XXL','XXXL'];
  const totals = {}; const takenBy = {}; sizes.forEach(s=>{ totals[s]=0; takenBy[s]=0; });
  DATA.forEach(d => {
    const s = (d.size_baju||'').toUpperCase();
    if(totals[s]!==undefined) totals[s]++;
    if((d.status||'').toLowerCase().includes('sudah') && takenBy[s]!==undefined) takenBy[s]++;
  });

  const grid = document.getElementById('statGrid'); grid.innerHTML='';
  grid.appendChild(stat('Total Peserta', total));
  grid.appendChild(stat('Sudah Ambil', taken));
  grid.appendChild(stat('Belum Ambil', notTaken));
  sizes.forEach(s=> grid.appendChild(stat('Size '+s, totals[s]+' (ambil '+takenBy[s]+')')));
}

function stat(title, val){
  const d = el('div',{class:'stat'}, '<div style=\"color:#666\">'+title+'</div><div class=\"n\">'+val+'</div>');
  return d;
}

function renderTable(rows){
  const tbody = document.querySelector('#tbl tbody'); tbody.innerHTML='';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.no_bib)}</td>
      <td>${escapeHtml(r.nama_peserta)}</td>
      <td>${escapeHtml(r.size_baju)}</td>
      <td>${escapeHtml(r.barcode)}</td>
      <td></td>
      <td><input class="inp" data-key="nama_staff" value="${escapeAttr(r.nama_staff||'')}"/></td>
      <td><input class="inp" data-key="nama_pengambil" value="${escapeAttr(r.nama_pengambil||'')}"/></td>
      <td><input class="inp" data-key="no_tlp_pengambil" value="${escapeAttr(r.no_tlp_pengambil||'')}"/></td>
      <td><input class="inp" data-key="id_card_pengambil" value="${escapeAttr(r.id_card_pengambil||'')}"/></td>
      <td><input class="inp" data-key="keterangan" value="${escapeAttr(r.keterangan||'')}"/></td>
      <td><button class="saveBtn">Simpan</button></td>
    `;
    // set status cell with select + badge
    const statusCell = tr.children[4];
    const select = el('select',{class:'sel'});
    ['', 'Belum', 'Sudah', 'Sudah Ambil'].forEach(o=> select.appendChild(el('option',{value:o}, o)));
    select.value = r.status || '';
    const badge = el('span',{}, '');
    setBadge(badge, r.status);
    select.addEventListener('change', ()=> setBadge(badge, select.value));
    statusCell.appendChild(select);
    statusCell.appendChild(badge);

    // save handler
    tr.querySelector('.saveBtn').addEventListener('click', ()=> {
      const payload = {
        password: sessionStorage.getItem('racepack_pwd') || '',
        no_bib: r.no_bib,
        status: select.value,
        nama_staff: tr.querySelector('input[data-key=\"nama_staff\"]').value,
        nama_pengambil: tr.querySelector('input[data-key=\"nama_pengambil\"]').value,
        no_tlp_pengambil: tr.querySelector('input[data-key=\"no_tlp_pengambil\"]').value,
        id_card_pengambil: tr.querySelector('input[data-key=\"id_card_pengambil\"]').value,
        keterangan: tr.querySelector('input[data-key=\"keterangan\"]').value
      };
      saveRow(payload, tr.querySelector('.saveBtn'));
    });

    tbody.appendChild(tr);
  });
}

function setBadge(el, status){
  const s = (status||'').toLowerCase();
  if(s.includes('sudah')) el.innerHTML = '<span class=\"status-badge sudah\">SUDAH</span>';
  else if(s.includes('belum')) el.innerHTML = '<span class=\"status-badge belum\">BELUM</span>';
  else el.innerHTML = '';
}

async function saveRow(payload, btn){
  btn.disabled = true; const oldText = btn.textContent; btn.textContent = 'Menyimpan...';
  try{
    const res = await fetch(WEBAPP, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const t = await res.text().catch(()=>null);
      throw new Error('HTTP '+res.status + (t?(' ‚Äî '+t):''));
    }
    const j = await res.json();
    if(j.success){
      showMsg('Berhasil disimpan', 'ok');
      // update local DATA
      const ix = DATA.findIndex(d => String(d.no_bib) === String(payload.no_bib));
      if(ix > -1){
        DATA[ix].status = payload.status;
        DATA[ix].nama_staff = payload.nama_staff;
        DATA[ix].nama_pengambil = payload.nama_pengambil;
        DATA[ix].no_tlp_pengambil = payload.no_tlp_pengambil;
        DATA[ix].id_card_pengambil = payload.id_card_pengambil;
        DATA[ix].keterangan = payload.keterangan;
      }
      renderStats();
    } else {
      throw new Error(j.message || 'Server balikan sukses:false');
    }
  }catch(err){
    console.error('Save error', err);
    showMsg('Error saat menyimpan: ' + (err.message || err), 'error');
  }finally{
    btn.disabled = false; btn.textContent = oldText;
  }
}

function filterTable(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  if(!q){ renderTable(DATA); return; }
  const f = DATA.filter(d=>{
    return String(d.no_bib||'').toLowerCase().includes(q) ||
           String(d.nama_peserta||'').toLowerCase().includes(q) ||
           String(d.barcode||'').toLowerCase().includes(q);
  });
  renderTable(f);
}

function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;'); }

// initial
window.addEventListener('load', ()=> {
  // if password already in sessionStorage, auto-load
  if(sessionStorage.getItem('racepack_pwd')) loadData();
});
</script>
</body>
</html>
