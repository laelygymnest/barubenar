<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Racepack</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: orange; color: white; }
    .warning { background: #ffe6e6; padding: 10px; border: 1px solid red; margin-bottom: 15px; }
    input { width: 100%; }
    .stok { background: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-bottom: 20px; }
  </style>
</head>
<body>

<div id="loginSection">
  <h2>Masukkan Password</h2>
  <input type="password" id="passwordInput">
  <button onclick="checkPassword()">Login</button>
</div>

<div id="contentSection" style="display:none;">
  <div class="warning">
    <strong>PERHATIAN:</strong> JIKA ADA PESERTA YANG PENGAMBILAN RACEPACKNYA DIWAKILKAN DAN TIDAK MEMBAWA SURAT KUASA, MAKA PESERTA BISA MENGIRIM SOFT FILE SURAT KUASA YANG SUDAH DI ISI DAN DITANDATANGANI BESERTA FOTO KTP DAN DI DM KE IG TEGAL CITY RUN. HAL INI UNTUK MENCEGAH HAL YANG TIDAK DIINGINKAN SEPERTI PENGAMBILAN RACEPACK BERULANG.  
    TUNJUKAN ID CARD & EMAIL VERIFIKASI
  </div>

  <div class="stok" id="stokInfo">
    <h3>Rincian Stok Size Baju</h3>
    <table id="stokTable">
      <thead>
        <tr>
          <th>Size</th>
          <th>Total</th>
          <th>Sudah Diambil</th>
          <th>Belum Diambil</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <table id="racepackTable">
    <thead>
      <tr>
        <th>No BIB</th>
        <th>Nama Peserta</th>
        <th>Size Baju</th>
        <th>Becode</th>
        <th>Status</th>
        <th>Nama Staff</th>
        <th>Nama Pengambil</th>
        <th>No Tlp Pengambil</th>
        <th>ID Card Pengambil</th>
        <th>Keterangan</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzhfk2Sp6-DB2z5mCl2Ssl5AwPoNginMeqKycVP4JYqi9sY0X2Uim8UGhFRAC2NFVMC/exec";
const PASSWORD = "12345"; // ganti sesuai kebutuhan

let totalPeserta = 2000;

function checkPassword() {
  const input = document.getElementById("passwordInput").value;
  if (input === PASSWORD) {
    sessionStorage.setItem("loggedIn", "true");
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("contentSection").style.display = "block";
    loadData();
  } else {
    alert("Password salah!");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  if (sessionStorage.getItem("loggedIn") === "true") {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("contentSection").style.display = "block";
    loadData();
  }
});

function loadData() {
  fetch(WEB_APP_URL)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#racepackTable tbody");
      const stokBody = document.querySelector("#stokTable tbody");
      tbody.innerHTML = "";
      stokBody.innerHTML = "";

      let stok = {};

      data.forEach((row, index) => {
        const size = row[2];
        const status = row[4]?.toLowerCase() === "sudah diambil";

        if (!stok[size]) {
          stok[size] = { total: 0, diambil: 0 };
        }
        stok[size].total++;
        if (status) stok[size].diambil++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row[0]}</td>
          <td>${row[1]}</td>
          <td>${row[2]}</td>
          <td><input value="${row[3] || ''}"></td>
          <td><input value="${row[4] || ''}"></td>
          <td><input value="${row[5] || ''}"></td>
          <td><input value="${row[6] || ''}"></td>
          <td><input value="${row[7] || ''}"></td>
          <td><input value="${row[8] || ''}"></td>
          <td><input value="${row[9] || ''}"></td>
          <td><button onclick="saveRow(${index})">Simpan</button></td>
        `;
        tbody.appendChild(tr);
      });

      Object.keys(stok).sort().forEach(size => {
        const belum = stok[size].total - stok[size].diambil;
        stokBody.innerHTML += `<tr>
          <td>${size}</td>
          <td>${stok[size].total}</td>
          <td>${stok[size].diambil}</td>
          <td>${belum}</td>
        </tr>`;
      });
    });
}

function saveRow(index) {
  const row = document.querySelectorAll("#racepackTable tbody tr")[index];
  const inputs = row.querySelectorAll("input");
  const updatedData = Array.from(inputs).map(input => input.value);

  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ rowIndex: index, updatedData }),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(resp => {
    if (resp.success) {
      alert("Data berhasil disimpan");
      loadData();
    } else {
      alert("Gagal menyimpan: " + resp.error);
    }
  });
}
</script>

</body>
</html>
