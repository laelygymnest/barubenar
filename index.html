<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Racepack TCR</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat&display=swap');

  :root {
    --orange: #ff7f27;
    --dark-orange: #cc661a;
    --background: #fff5e6;
    --text-color: #333;
    --border-color: #ffad5e;
  }

  body {
    margin: 0;
    font-family: 'Montserrat', sans-serif;
    background: var(--background);
    color: var(--text-color);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    background: var(--orange);
    color: white;
    padding: 16px 24px;
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 3px 5px rgba(0,0,0,0.15);
  }

  header img.logo {
    height: 50px;
  }

  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.5rem;
  }

  main {
    flex: 1;
    padding: 20px 24px 40px 24px;
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
  }

  .warning {
    background: #fff4e6;
    border-left: 6px solid var(--dark-orange);
    padding: 16px;
    margin-bottom: 24px;
    border-radius: 6px;
    font-weight: 600;
    color: #663300;
    font-size: 0.9rem;
    line-height: 1.4;
  }

  /* Siluet orang lari di kanan bawah */
  body::after {
    content: "";
    position: fixed;
    right: 0;
    bottom: 0;
    width: 200px;
    height: 200px;
    background: url('https://i.imgur.com/7HMPcFx.png') no-repeat center/contain;
    opacity: 0.15;
    pointer-events: none;
    user-select: none;
  }

  #loginSection {
    max-width: 400px;
    margin: 80px auto;
    background: white;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgb(255 127 39 / 0.4);
    text-align: center;
  }

  #loginSection h2 {
    margin-bottom: 24px;
    color: var(--orange);
  }

  #loginSection input {
    width: 100%;
    font-size: 1rem;
    padding: 12px;
    border: 2px solid var(--orange);
    border-radius: 8px;
    margin-bottom: 20px;
  }

  #loginSection button {
    background: var(--orange);
    border: none;
    padding: 12px 24px;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
  }

  #loginSection button:hover {
    background: var(--dark-orange);
  }

  #contentSection {
    display: none;
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 24px;
    align-items: center;
  }

  .controls input[type="text"] {
    flex-grow: 1;
    font-size: 1rem;
    padding: 8px 12px;
    border: 2px solid var(--orange);
    border-radius: 8px;
  }

  .controls button {
    background: var(--orange);
    border: none;
    padding: 10px 20px;
    color: white;
    font-weight: 700;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .controls button:hover {
    background: var(--dark-orange);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgb(255 127 39 / 0.3);
  }

  th, td {
    padding: 12px 10px;
    border-bottom: 1px solid #f0a759;
    text-align: left;
    font-size: 0.9rem;
  }

  th {
    background: var(--orange);
    color: white;
    font-weight: 700;
  }

  tbody tr:hover {
    background: #ffe6cc;
  }

  input[type="text"] {
    font-size: 0.9rem;
    width: 100%;
    padding: 6px 8px;
    border: 1.5px solid var(--orange);
    border-radius: 6px;
  }

  input[type="text"]:focus {
    outline: none;
    border-color: var(--dark-orange);
  }

  button.save-btn {
    background: var(--dark-orange);
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s;
  }

  button.save-btn:hover {
    background: #a3530e;
  }

  /* Statistik stok */
  #stokSection {
    margin: 30px 0 50px;
  }

  #stokSection h3 {
    margin-bottom: 12px;
    color: var(--dark-orange);
    font-weight: 700;
  }

  #stokTable {
    width: 400px;
    max-width: 100%;
    border-collapse: collapse;
  }

  #stokTable th, #stokTable td {
    border: 1.5px solid var(--orange);
    padding: 10px 15px;
    font-weight: 600;
    font-size: 1rem;
    text-align: center;
  }

  #stokTable th {
    background: var(--orange);
    color: white;
  }

  #stokTable tfoot th {
    background: var(--dark-orange);
    color: white;
  }

  @media(max-width: 720px) {
    header {
      flex-wrap: wrap;
      justify-content: center;
    }
    #stokTable {
      width: 100%;
    }
  }
</style>
</head>
<body>

<header>
  <img src="https://i.imgur.com/O4qhLOz.png" alt="Logo TCR" class="logo" />
  <h1>Tegal City Run - Admin Racepack</h1>
</header>

<main>
  <!-- Login Section -->
  <section id="loginSection">
    <h2>Login Admin</h2>
    <input type="password" id="passwordInput" placeholder="Masukkan password" />
    <button id="loginBtn">Masuk</button>
  </section>

  <!-- Konten utama setelah login -->
  <section id="contentSection" style="display:none;">
    <div class="warning" role="alert" aria-live="polite">
      JIKA ADA PESERTA YANG PENGAMBILAN RACEPACKNYA DIWAKILKAN DAN TIDAK MEMBAWA SURAT KUASA,
      MAKA PESERTA BISA MENGIRIM SOFT FILE SURAT KUASA YANG SUDAH DI ISI DAN DITANDATANGANI BESERTA FOTO KTP
      DAN DI DM KE IG TEGAL CITY RUN. HAL INI UNTUK MENCEGAH HAL YANG TIDAK DIINGINKAN SEPERTI PENGAMBILAN RACEPACK BERULANG.
      <br><strong>TUNJUKAN ID CARD & EMAIL VERIFIKASI</strong>
    </div>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="Cari No Bib, Nama Peserta, Bercode..." />
      <button id="reloadBtn">Reload Data</button>
    </div>

    <div id="stokSection">
      <h3>Rincian Stok Size Baju</h3>
      <table id="stokTable" aria-label="Rincian stok size baju">
        <thead>
          <tr>
            <th>Size</th>
            <th>Total</th>
            <th>Sudah Diambil</th>
            <th>Belum Diambil</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th>Total Keseluruhan</th>
            <th id="totalAll">0</th>
            <th id="totalTaken">0</th>
            <th id="totalRemain">0</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <table id="dataTable" aria-label="Tabel data racepack">
      <thead>
        <tr>
          <th>No Bib</th>
          <th>Nama Peserta</th>
          <th>Size Baju</th>
          <th>Bercode</th>
          <th>Status</th>
          <th>Nama Staff</th>
          <th>Nama Pengambil</th>
          <th>No Tlp Pengambil</th>
          <th>ID Card Pengambil</th>
          <th>Keterangan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </section>
</main>

<script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxJ5rlrXVY9NxoggS2mWnBpDOmH56l8E3Pg6ZaID_z0ZWhZZujKYj_Djm6AKv6m4TOy/exec'; // Ganti dengan URL web app kamu
  const PASSWORD = 'rahasia123'; // Ganti dengan password yang sama dengan di apps script

  const loginSection = document.getElementById('loginSection');
  const contentSection = document.getElementById('contentSection');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const searchInput = document.getElementById('searchInput');
  const reloadBtn = document.getElementById('reloadBtn');
  const dataTableBody = document.querySelector('#dataTable tbody');
  const stokTableBody = document.querySelector('#stokTable tbody');
  const totalAllEl = document.getElementById('totalAll');
  const totalTakenEl = document.getElementById('totalTaken');
  const totalRemainEl = document.getElementById('totalRemain');

  let racepackData = [];
  let filteredData = [];

  // Cek session login
  if (sessionStorage.getItem('loggedIn') === 'true') {
    showContent();
    fetchData();
  }

  loginBtn.addEventListener('click', () => {
    if (passwordInput.value === PASSWORD) {
      sessionStorage.setItem('loggedIn', 'true');
      showContent();
      fetchData();
    } else {
      alert('Password salah!');
    }
  });

  reloadBtn.addEventListener('click', fetchData);

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    filteredData = racepackData.filter(item => {
      return (item.no_bib && item.no_bib.toLowerCase().includes(query)) ||
             (item.nama_peserta && item.nama_peserta.toLowerCase().includes(query)) ||
             (item.bercode && item.bercode.toLowerCase().includes(query));
    });
    renderTable(filteredData);
    renderStok(filteredData);
  });

  function showContent() {
    loginSection.style.display = 'none';
    contentSection.style.display = 'block';
  }

  async function fetchData() {
    try {
      const res = await fetch(WEB_APP_URL);
      if (!res.ok) throw new Error('Gagal mengambil data');
      const data = await res.json();
      racepackData = data;
      filteredData = data;
      renderTable(data);
      renderStok(data);
    } catch (error) {
      alert('Error mengambil data: ' + error.message);
    }
  }

  function renderTable(data) {
    dataTableBody.innerHTML = '';
    data.forEach((row, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.no_bib || ''}</td>
        <td>${row.nama_peserta || ''}</td>
        <td>${row.size_baju || ''}</td>
        <td>${row.bercode || ''}</td>
        <td><input type="text" data-field="status" data-index="${index}" value="${row.status || ''}"></td>
        <td><input type="text
